# =============================================================================
# Skyie Blaze - Continuous Integration Pipeline
# =============================================================================
# Triggers:
#   - Pull requests to any branch
#   - Push to main branch
#
# Stages:
#   1. Checkout & Setup
#   2. Static Validation (schemas, OpenAPI)
#   3. Tests (unit, golden, enforcement)
#   4. Build (Docker images)
#   5. Security Scan
#   6. Artifact Push (on main only)
# =============================================================================

name: CI Pipeline

on:
  pull_request:
    branches: ['*']
  push:
    branches: [main]

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

# Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # STAGE 1: Checkout & Setup
  # ===========================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      sha_short: ${{ steps.version.outputs.sha_short }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Extract version info
        id: version
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  # ===========================================================================
  # STAGE 2: Static Validation
  # ===========================================================================
  validate-schemas:
    name: Validate Schemas
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Brand Genome Schema
        run: |
          npx ajv compile \
            --spec=draft2020 \
            --strict=false \
            -s backend/shared/schemas/brand-genome.schema.json

      - name: Validate Campaign Blueprint Schema
        run: |
          npx ajv compile \
            --spec=draft2020 \
            --strict=false \
            -s backend/shared/schemas/campaign-blueprint.schema.json

      - name: Check for unknown fields in schemas
        run: |
          node scripts/ci/validate-schemas.js

  validate-openapi:
    name: Validate OpenAPI
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate OpenAPI specification
        run: |
          npx @redocly/cli lint backend/api/openapi.yaml --format=github-actions

      - name: Check OpenAPI for breaking changes
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          npx @redocly/cli diff \
            origin/${{ github.base_ref }}:backend/api/openapi.yaml \
            backend/api/openapi.yaml \
            --fail-on-incompatible-changes || echo "::warning::Breaking API changes detected"

  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint --if-present

      - name: Check formatting
        run: npm run format:check --if-present

  # ===========================================================================
  # STAGE 3: Tests
  # ===========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [validate-schemas, validate-openapi]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit --if-present
        env:
          CI: true

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: coverage/
          retention-days: 7

  golden-tests:
    name: Golden Tests
    runs-on: ubuntu-latest
    needs: [validate-schemas, validate-openapi]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run golden tests
        run: |
          node scripts/ci/run-golden-tests.js
        env:
          CI: true
          GOLDEN_TESTS_PATH: backend/tests/golden/golden-tests.yaml
          STRUCTURAL_ONLY: true # Structural validation only until enforcement engine is implemented

      - name: Upload golden test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: golden-test-results
          path: reports/golden-tests/
          retention-days: 30

  enforcement-tests:
    name: Enforcement Validation Tests
    runs-on: ubuntu-latest
    needs: [validate-schemas, validate-openapi]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run enforcement tests
        run: npm run test:enforcement --if-present
        env:
          CI: true

  # ===========================================================================
  # STAGE 4: Build
  # ===========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [unit-tests, golden-tests, enforcement-tests, lint]
    strategy:
      matrix:
        service: [brand-service, campaign-service, enforcement-engine]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if service exists
        id: check_service
        run: |
          if [ -d "backend/services/${{ matrix.service }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Service ${{ matrix.service }} not yet implemented, skipping Docker build"
          fi

      - name: Set up Docker Buildx
        if: steps.check_service.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: steps.check_service.outputs.exists == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.check_service.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=ref,event=pr

      - name: Build Docker image
        if: steps.check_service.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            SERVICE=${{ matrix.service }}
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        if: steps.check_service.outputs.exists == 'true'
        run: |
          docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ github.sha }} \
            node --version

  # ===========================================================================
  # STAGE 5: Security Scan
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --audit-level=critical
        continue-on-error: false

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  # ===========================================================================
  # STAGE 6: Push Artifacts (main branch only)
  # ===========================================================================
  push-artifacts:
    name: Push Docker Images
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        service: [brand-service, campaign-service, enforcement-engine]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if service exists
        id: check_service
        run: |
          if [ -d "backend/services/${{ matrix.service }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::notice::Service ${{ matrix.service }} not yet implemented, skipping push"
          fi

      - name: Set up Docker Buildx
        if: steps.check_service.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: steps.check_service.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: steps.check_service.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        if: steps.check_service.outputs.exists == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            SERVICE=${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # CI Summary
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [push-artifacts]
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.push-artifacts.result }}" == "success" ] || [ "${{ needs.push-artifacts.result }}" == "skipped" ]; then
            echo "CI pipeline completed successfully!"
            exit 0
          else
            echo "CI pipeline failed"
            exit 1
          fi
