# =============================================================================
# Skyie Blaze - Production Override (Traefik Integration)
# =============================================================================
# Usage: docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d
#
# Traefik Configuration:
#   - Domain: api.skyie.io
#   - TLS: Let's Encrypt via existing Traefik resolver
#   - Routing: Path-based (/v1/brands, /v1/campaigns, /v1/content)
#
# Prerequisites:
#   - Traefik network must exist: docker network inspect traefik
#   - Traefik must have certresolver named 'letsencrypt'
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Brand Service - Traefik Enabled (Production)
  # ---------------------------------------------------------------------------
  brand-service:
    image: ghcr.io/sgadminuk/skyie-blaze/brand-service:${RELEASE_TAG:-latest}
    build: {}  # Disable build in production
    ports: []  # No exposed ports - Traefik handles routing
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=warn
    networks:
      - skyie-internal
      - traefik
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTPS Redirect Middleware (defined here, shared by all)
      - "traefik.http.middlewares.skyie-blaze-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.skyie-blaze-https-redirect.redirectscheme.permanent=true"

      # Security Headers Middleware
      - "traefik.http.middlewares.skyie-blaze-security.headers.frameDeny=true"
      - "traefik.http.middlewares.skyie-blaze-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.skyie-blaze-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.skyie-blaze-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.skyie-blaze-security.headers.stsIncludeSubdomains=true"

      # Rate Limiting Middleware
      - "traefik.http.middlewares.skyie-blaze-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.skyie-blaze-ratelimit.ratelimit.burst=50"

      # HTTP Router - Redirect to HTTPS
      - "traefik.http.routers.skyie-blaze-brand-http.rule=Host(`api.skyie.io`) && PathPrefix(`/v1/brands`)"
      - "traefik.http.routers.skyie-blaze-brand-http.entrypoints=web"
      - "traefik.http.routers.skyie-blaze-brand-http.middlewares=skyie-blaze-https-redirect"

      # HTTPS Router
      - "traefik.http.routers.skyie-blaze-brand.rule=Host(`api.skyie.io`) && PathPrefix(`/v1/brands`)"
      - "traefik.http.routers.skyie-blaze-brand.entrypoints=websecure"
      - "traefik.http.routers.skyie-blaze-brand.tls=true"
      - "traefik.http.routers.skyie-blaze-brand.tls.certresolver=letsencrypt"
      - "traefik.http.routers.skyie-blaze-brand.middlewares=skyie-blaze-security,skyie-blaze-ratelimit"
      - "traefik.http.routers.skyie-blaze-brand.service=skyie-blaze-brand"

      # Service configuration
      - "traefik.http.services.skyie-blaze-brand.loadbalancer.server.port=3000"
      - "traefik.http.services.skyie-blaze-brand.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.skyie-blaze-brand.loadbalancer.healthcheck.interval=30s"

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ---------------------------------------------------------------------------
  # Campaign Service - Traefik Enabled (Production)
  # ---------------------------------------------------------------------------
  campaign-service:
    image: ghcr.io/sgadminuk/skyie-blaze/campaign-service:${RELEASE_TAG:-latest}
    build: {}
    ports: []
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=warn
    networks:
      - skyie-internal
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP Router - Redirect to HTTPS
      - "traefik.http.routers.skyie-blaze-campaign-http.rule=Host(`api.skyie.io`) && PathPrefix(`/v1/campaigns`)"
      - "traefik.http.routers.skyie-blaze-campaign-http.entrypoints=web"
      - "traefik.http.routers.skyie-blaze-campaign-http.middlewares=skyie-blaze-https-redirect"

      # HTTPS Router
      - "traefik.http.routers.skyie-blaze-campaign.rule=Host(`api.skyie.io`) && PathPrefix(`/v1/campaigns`)"
      - "traefik.http.routers.skyie-blaze-campaign.entrypoints=websecure"
      - "traefik.http.routers.skyie-blaze-campaign.tls=true"
      - "traefik.http.routers.skyie-blaze-campaign.tls.certresolver=letsencrypt"
      - "traefik.http.routers.skyie-blaze-campaign.middlewares=skyie-blaze-security,skyie-blaze-ratelimit"
      - "traefik.http.routers.skyie-blaze-campaign.service=skyie-blaze-campaign"

      # Service configuration
      - "traefik.http.services.skyie-blaze-campaign.loadbalancer.server.port=3000"
      - "traefik.http.services.skyie-blaze-campaign.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.skyie-blaze-campaign.loadbalancer.healthcheck.interval=30s"

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ---------------------------------------------------------------------------
  # Enforcement Engine - Traefik Enabled (Production)
  # ---------------------------------------------------------------------------
  enforcement-engine:
    image: ghcr.io/sgadminuk/skyie-blaze/enforcement-engine:${RELEASE_TAG:-latest}
    build: {}
    ports: []
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=warn
    networks:
      - skyie-internal
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP Router - Redirect to HTTPS
      - "traefik.http.routers.skyie-blaze-enforcement-http.rule=Host(`api.skyie.io`) && PathPrefix(`/v1/content`)"
      - "traefik.http.routers.skyie-blaze-enforcement-http.entrypoints=web"
      - "traefik.http.routers.skyie-blaze-enforcement-http.middlewares=skyie-blaze-https-redirect"

      # HTTPS Router
      - "traefik.http.routers.skyie-blaze-enforcement.rule=Host(`api.skyie.io`) && PathPrefix(`/v1/content`)"
      - "traefik.http.routers.skyie-blaze-enforcement.entrypoints=websecure"
      - "traefik.http.routers.skyie-blaze-enforcement.tls=true"
      - "traefik.http.routers.skyie-blaze-enforcement.tls.certresolver=letsencrypt"
      - "traefik.http.routers.skyie-blaze-enforcement.middlewares=skyie-blaze-security,skyie-blaze-ratelimit"
      - "traefik.http.routers.skyie-blaze-enforcement.service=skyie-blaze-enforcement"

      # Service configuration
      - "traefik.http.services.skyie-blaze-enforcement.loadbalancer.server.port=3000"
      - "traefik.http.services.skyie-blaze-enforcement.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.skyie-blaze-enforcement.loadbalancer.healthcheck.interval=30s"

    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ---------------------------------------------------------------------------
  # Infrastructure - No external exposure
  # ---------------------------------------------------------------------------
  postgres:
    ports: []  # Never expose DB port in production
    environment:
      - POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256

  redis:
    ports: []  # Never expose Redis port in production

  # nginx is NOT deployed - Traefik handles routing
